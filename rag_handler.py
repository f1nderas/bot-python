import sqlite3
from datetime import datetime
import numpy as np
from sentence_transformers import SentenceTransformer
from sklearn.metrics.pairwise import cosine_similarity
import logging
import nltk
from nltk.tokenize import sent_tokenize

# –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã –¥–ª—è NLTK
try:
    nltk.data.find('tokenizers/punkt_tab')
except LookupError:
    nltk.download('punkt_tab', quiet=True)


logger = logging.getLogger(__name__)

class RAGHandler:
    def __init__(self, db_path='nutrition_bot.db',
                 model_name='sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2'):
        self.db_path = db_path
        self.model = SentenceTransformer(model_name)
        self.init_vector_db()
        self.abbreviations = {
            "–∂–∫—Ç": "–∂–µ–ª—É–¥–æ—á–Ω–æ-–∫–∏—à–µ—á–Ω—ã–π —Ç—Ä–∞–∫—Ç",
            "—Ü–Ω—Å": "—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –Ω–µ—Ä–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞",
            "–∏–º—Ç": "–∏–Ω–¥–µ–∫—Å –º–∞—Å—Å—ã —Ç–µ–ª–∞",
            "—Å—Ä": "—Å—Ä–µ–¥—Å—Ç–≤–æ",
            "–±–∞–¥": "–±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–Ω–∞—è –¥–æ–±–∞–≤–∫–∞",
            "—ç–º": "—ç—Ñ–∏—Ä–Ω–æ–µ –º–∞—Å–ª–æ",
            "–¥–æ—Ç–µ—Ä—Ä–∞": "doTERRA –ë–ê–î",
            "–î–æ—Ç–µ—Ä—Ä": "doTERRA –ë–ê–î",
            "–≤–∏—Ç": "–≤–∏—Ç–∞–º–∏–Ω",
            "–º–∏–Ω": "–º–∏–Ω–µ—Ä–∞–ª",
            "–∞–Ω—Ç–∏–æ–∫—Å": "–∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç"
        }

    def init_vector_db(self):
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        cursor.execute('''CREATE TABLE IF NOT EXISTS knowledge_vectors (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        question TEXT,
                        answer TEXT,
                        context TEXT,
                        vector BLOB NOT NULL,
                        last_used DATETIME,
                        usage_count INTEGER DEFAULT 1,
                        is_from_pdf BOOLEAN DEFAULT 0,
                        tags TEXT)''')
        conn.commit()
        conn.close()
        logger.info("–í–µ–∫—Ç–æ—Ä–Ω–∞—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")

    def text_to_vector(self, text):
        if not text or not isinstance(text, str):
            logger.warning("–ü–æ–ø—ã—Ç–∫–∞ –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—É—Å—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞")
            return np.zeros(self.model.get_sentence_embedding_dimension())
        return self.model.encode(text)

    def vector_to_blob(self, vector):
        return vector.tobytes()

    def blob_to_vector(self, blob):
        return np.frombuffer(blob, dtype=np.float32)

    def expand_abbreviations(self, query):
        query_lower = query.lower()
        expanded_query = query_lower
        for abbr, full_form in self.abbreviations.items():
            if f" {abbr} " in f" {query_lower} " or query_lower.startswith(f"{abbr} ") or query_lower.endswith(f" {abbr}"):
                expanded_query += f" {full_form}"
        logger.debug(f"–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å: {expanded_query}")
        return expanded_query.strip()

    def _split_text_into_chunks(self, text: str, chunk_size: int = 2000) -> list:
        """–†–∞–∑–±–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –Ω–∞ —á–∞–Ω–∫–∏ –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º, —Å–æ—Ö—Ä–∞–Ω—è—è —Å–º—ã—Å–ª–æ–≤—É—é —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å"""
        sentences = sent_tokenize(text, language="russian")
        chunks = []
        current_chunk = ""
        for sentence in sentences:
            if len(current_chunk) + len(sentence) <= chunk_size:
                current_chunk += sentence + " "
            else:
                if current_chunk.strip():
                    chunks.append(current_chunk.strip())
                current_chunk = sentence + " "
        if current_chunk.strip():
            chunks.append(current_chunk.strip())
        logger.debug(f"–¢–µ–∫—Å—Ç —Ä–∞–∑–±–∏—Ç –Ω–∞ {len(chunks)} —á–∞–Ω–∫–æ–≤")
        return chunks

    def find_relevant_context(self, query, threshold=0.7, top_k=3, min_threshold=0.4):
        expanded_query = self.expand_abbreviations(query)
        query_vector = self.text_to_vector(expanded_query)
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        cursor.execute('''SELECT id, question, answer, context, vector, is_from_pdf, tags 
                         FROM knowledge_vectors''')
        results = cursor.fetchall()
        conn.close()

        similarities = []
        query_lower = expanded_query.lower()
        keyword_groups = {
            "heart": [
                "—Å–µ—Ä–¥—Ü–µ", "—Å–æ—Å—É–¥—ã", "–∫—Ä–æ–≤–æ–æ–±—Ä–∞—â–µ–Ω–∏–µ", "–¥–∞–≤–ª–µ–Ω–∏–µ", "—Ö–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω", "–≥–∏–ø–µ—Ä—Ç–æ–Ω–∏—è", "–∞—Ä—Ç–µ—Ä–∏–∏",
                "–∞—Ä–∏—Ç–º–∏—è", "—Ç–∞—Ö–∏–∫–∞—Ä–¥–∏—è", "–±—Ä–∞–¥–∏–∫–∞—Ä–¥–∏—è", "–∞—Ç–µ—Ä–æ—Å–∫–ª–µ—Ä–æ–∑", "—Å–µ—Ä–¥–µ—á–Ω–∞—è –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å",
                "–∫—Ä–æ–≤—è–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ", "–≤–µ–Ω–æ–∑–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞", "–∫–∞–ø–∏–ª–ª—è—Ä—ã", "—Å–µ—Ä–¥–µ—á–Ω—ã–π —Ä–∏—Ç–º", "–º–∏–æ–∫–∞—Ä–¥"
            ],
            "sleep": [
                "—Å–æ–Ω", "–±–µ—Å—Å–æ–Ω–Ω–∏—Ü–∞", "—É—Å–Ω—É—Ç—å", "–æ—Ç–¥—ã—Ö", "—Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ", "—Å–ø–∞—Ç—å", "–Ω–æ—á–Ω–æ–π",
                "–∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞", "–≥–ª—É–±–æ–∫–∏–π —Å–æ–Ω", "–ø—Ä–æ–±–ª–µ–º—ã —Å–æ —Å–Ω–æ–º", "—Å–æ–Ω–ª–∏–≤–æ—Å—Ç—å", "—Ü–∏—Ä–∫–∞–¥–Ω—ã–π —Ä–∏—Ç–º",
                "–º–µ–ª–∞—Ç–æ–Ω–∏–Ω", "–Ω–∞—Ä—É—à–µ–Ω–∏–µ —Å–Ω–∞", "–¥–Ω–µ–≤–Ω–∞—è —É—Å—Ç–∞–ª–æ—Å—Ç—å", "–ø—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ"
            ],
            "stress": [
                "—Å—Ç—Ä–µ—Å—Å", "—Ç—Ä–µ–≤–æ–≥–∞", "–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ", "–Ω–µ—Ä–≤—ã", "—É—Å–ø–æ–∫–æ–µ–Ω–∏–µ", "–ø–∞–Ω–∏–∫–∞", "—ç–º–æ—Ü–∏–∏",
                "–Ω–µ—Ä–≤–æ–∑–Ω–æ—Å—Ç—å", "–ø–µ—Ä–µ—É—Ç–æ–º–ª–µ–Ω–∏–µ", "–≤—ã–≥–æ—Ä–∞–Ω–∏–µ", "—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ", "—Ä–µ–ª–∞–∫—Å–∞—Ü–∏—è",
                "–ø—Å–∏—Ö–æ—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ", "—Å—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å", "–∫–æ—Ä—Ç–∏–∑–æ–ª", "–∞–¥–∞–ø—Ç–∞—Ü–∏—è"
            ],
            "energy": [
                "—ç–Ω–µ—Ä–≥–∏—è", "–±–æ–¥—Ä–æ—Å—Ç—å", "—É—Å—Ç–∞–ª–æ—Å—Ç—å", "–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å", "–∂–∏–∑–Ω–µ–Ω–Ω–∞—è —Å–∏–ª–∞", "—Ç–æ–Ω—É—Å",
                "—É–ø–∞–¥–æ–∫ —Å–∏–ª", "—ç–Ω–µ—Ä–≥–∏—á–Ω–æ—Å—Ç—å", "–≤—è–ª–æ—Å—Ç—å", "—Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–ª–æ—Å—Ç—å", "–≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å",
                "–º–∏—Ç–æ—Ö–æ–Ω–¥—Ä–∏–∏", "—ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –±–∞–ª–∞–Ω—Å", "–∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ç–æ–Ω—É—Å", "—Å–∏–ª–∞"
            ],
            "gut": [
                "–∂–∫—Ç", "–ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏–µ", "–∂–µ–ª—É–¥–æ–∫", "–∫–∏—à–µ—á–Ω–∏–∫", "–º–∏–∫—Ä–æ—Ñ–ª–æ—Ä–∞", "–∑–∞–ø–æ—Ä", "–¥–∏–∞—Ä–µ—è",
                "–≥–∞—Å—Ç—Ä–∏—Ç", "–¥–∏—Å–±–∞–∫—Ç–µ—Ä–∏–æ–∑", "–≤–∑–¥—É—Ç–∏–µ", "—Ä–µ—Ñ–ª—é–∫—Å", "–ø–µ—Ä–∏—Å—Ç–∞–ª—å—Ç–∏–∫–∞", "—ç–Ω–∑–∏–º—ã",
                "–º–∏–∫—Ä–æ–±–∏–æ–º", "—Å–∏–Ω–¥—Ä–æ–º —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–Ω–æ–≥–æ –∫–∏—à–µ—á–Ω–∏–∫–∞", "—Ñ–µ—Ä–º–µ–Ω—Ç—ã", "–∫–∏—à–µ—á–Ω–∞—è –ø—Ä–æ–Ω–∏—Ü–∞–µ–º–æ—Å—Ç—å",
                "—è–∑–≤–∞", "–∫–æ–ª–∏—Ç"
            ],
            "immunity": [
                "–∏–º–º—É–Ω–∏—Ç–µ—Ç", "–∑–∞—â–∏—Ç–∞ –æ—Ä–≥–∞–Ω–∏–∑–º–∞", "–∏–Ω—Ñ–µ–∫—Ü–∏–∏", "–ø—Ä–æ—Å—Ç—É–¥–∞", "–≤–∏—Ä—É—Å—ã", "–∏–º–º—É–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞",
                "–≥—Ä–∏–ø–ø", "–û–†–í–ò", "–∏–º–º—É–Ω–æ–¥–µ—Ñ–∏—Ü–∏—Ç", "–∏–º–º—É–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç", "–≤–∞–∫—Ü–∏–Ω–∞—Ü–∏—è", "–∞–Ω—Ç–∏—Ç–µ–ª–∞",
                "–ª–∏–º—Ñ–æ—Ü–∏—Ç—ã", "–≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã", "–∏–Ω—Ç–µ—Ä—Ñ–µ—Ä–æ–Ω—ã", "—É–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –∏–º–º—É–Ω–∏—Ç–µ—Ç–∞"
            ],
            "joints": [
                "—Å—É—Å—Ç–∞–≤—ã", "–∫–æ—Å—Ç–∏", "—Ö—Ä—è—â–∏", "–∞—Ä—Ç—Ä–∏—Ç", "–±–æ–ª—å –≤ —Å—É—Å—Ç–∞–≤–∞—Ö", "–≥–∏–±–∫–æ—Å—Ç—å", "–æ—Å—Ç–µ–æ–ø–æ—Ä–æ–∑",
                "–∞—Ä—Ç—Ä–æ–∑", "—Ä–µ–≤–º–∞—Ç–∏–∑–º", "–æ—Å—Ç–µ–æ—Ö–æ–Ω–¥—Ä–æ–∑", "–ø–æ–¥–∞–≥—Ä–∞", "—Ö–æ–Ω–¥—Ä–æ–ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä—ã", "—Å–∏–Ω–æ–≤–∏–∞–ª—å–Ω–∞—è –∂–∏–¥–∫–æ—Å—Ç—å",
                "—Å—É—Å—Ç–∞–≤–Ω–∞—è —Å–º–∞–∑–∫–∞", "–∫–æ–ª–ª–∞–≥–µ–Ω", "–º–∏–Ω–µ—Ä–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ—Å—Ç–µ–π", "–ø–µ—Ä–µ–ª–æ–º—ã"
            ],
            "skin": [
                "–∫–æ–∂–∞", "–¥–µ—Ä–º–∞", "–∞–∫–Ω–µ", "–ø—Ä—ã—â–∏", "—É–≤–ª–∞–∂–Ω–µ–Ω–∏–µ –∫–æ–∂–∏", "—ç–∫–∑–µ–º–∞", "–ø—Å–æ—Ä–∏–∞–∑",
                "–¥–µ—Ä–º–∞—Ç–∏—Ç", "—Å—É—Ö–æ—Å—Ç—å –∫–æ–∂–∏", "–º–æ—Ä—â–∏–Ω—ã", "–ø–∏–≥–º–µ–Ω—Ç–∞—Ü–∏—è", "–ø–æ–∫—Ä–∞—Å–Ω–µ–Ω–∏–µ", "—Å—ã–ø—å",
                "–∫–æ–ª–ª–∞–≥–µ–Ω –∫–æ–∂–∏", "—ç–ª–∞—Å—Ç–∏—á–Ω–æ—Å—Ç—å –∫–æ–∂–∏", "–∑–∞–∂–∏–≤–ª–µ–Ω–∏–µ —Ä–∞–Ω", "–∫–æ–∂–Ω—ã–π –∑—É–¥", "—à–µ–ª—É—à–µ–Ω–∏–µ"
            ],
            "hair": [
                "–≤–æ–ª–æ—Å—ã", "–≤—ã–ø–∞–¥–µ–Ω–∏–µ –≤–æ–ª–æ—Å", "–ª–æ–º–∫–æ—Å—Ç—å –≤–æ–ª–æ—Å", "–ø–µ—Ä—Ö–æ—Ç—å", "—Ä–æ—Å—Ç –≤–æ–ª–æ—Å", "–∑–¥–æ—Ä–æ–≤—å–µ –≤–æ–ª–æ—Å",
                "—Å–µ–±–æ—Ä–µ—è", "–∞–ª–æ–ø–µ—Ü–∏—è", "—Å–µ–∫—É—â–∏–µ—Å—è –∫–æ–Ω—Ü—ã", "—É–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –≤–æ–ª–æ—Å", "–≤–æ–ª–æ—Å—è–Ω—ã–µ –ª—É–∫–æ–≤–∏—Ü—ã",
                "–∫–æ–∂–∞ –≥–æ–ª–æ–≤—ã", "–∂–∏—Ä–Ω–æ—Å—Ç—å –≤–æ–ª–æ—Å", "—Å—É—Ö–æ—Å—Ç—å –≤–æ–ª–æ—Å", "–±–ª–µ—Å–∫ –≤–æ–ª–æ—Å"
            ],
            "vision": [
                "–∑—Ä–µ–Ω–∏–µ", "–≥–ª–∞–∑–∞", "—É—Å—Ç–∞–ª–æ—Å—Ç—å –≥–ª–∞–∑", "–∫–∞—Ç–∞—Ä–∞–∫—Ç–∞", "–≥–ª–∞—É–∫–æ–º–∞", "–∑–¥–æ—Ä–æ–≤—å–µ –≥–ª–∞–∑",
                "–¥–∞–ª—å–Ω–æ–∑–æ—Ä–∫–æ—Å—Ç—å", "–±–ª–∏–∑–æ—Ä—É–∫–æ—Å—Ç—å", "–∞—Å—Ç–∏–≥–º–∞—Ç–∏–∑–º", "—Å—É—Ö–æ—Å—Ç—å –≥–ª–∞–∑", "—Å–µ—Ç—á–∞—Ç–∫–∞",
                "—Ö—Ä—É—Å—Ç–∞–ª–∏–∫", "–≥–ª–∞–∑–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ", "–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞", "—Ü–≤–µ—Ç–æ–≤–æ–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ"
            ],
            "hormones": [
                "–≥–æ—Ä–º–æ–Ω—ã", "–≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å", "—â–∏—Ç–æ–≤–∏–¥–∫–∞", "–º–µ–Ω–æ–ø–∞—É–∑–∞", "–ª–∏–±–∏–¥–æ", "—ç–Ω–¥–æ–∫—Ä–∏–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞",
                "—Ç–∏—Ä–µ–æ–∏–¥–Ω—ã–µ –≥–æ—Ä–º–æ–Ω—ã", "—ç—Å—Ç—Ä–æ–≥–µ–Ω", "–ø—Ä–æ–≥–µ—Å—Ç–µ—Ä–æ–Ω", "—Ç–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω", "–∏–Ω—Å—É–ª–∏–Ω",
                "–≥–æ—Ä–º–æ–Ω —Ä–æ—Å—Ç–∞", "–∞–¥—Ä–µ–Ω–∞–ª–∏–Ω", "–≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–π —Å–±–æ–π", "–Ω–∞–¥–ø–æ—á–µ—á–Ω–∏–∫–∏", "–≥–∏–ø–æ—Ç–∞–ª–∞–º—É—Å"
            ],
            "detox": [
                "–¥–µ—Ç–æ–∫—Å–∏–∫–∞—Ü–∏—è", "–æ—á–∏—â–µ–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–º–∞", "—Ç–æ–∫—Å–∏–Ω—ã", "–ø–µ—á–µ–Ω—å", "–ø–æ—á–∫–∏", "—á–∏—Å—Ç–∫–∞",
                "—à–ª–∞–∫–∏", "–¥–µ—Ç–æ–∫—Å-–ø—Ä–æ–≥—Ä–∞–º–º—ã", "–∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç—ã", "–≤—ã–≤–µ–¥–µ–Ω–∏–µ —Ç–æ–∫—Å–∏–Ω–æ–≤", "–ª–∏–º—Ñ–æ–¥—Ä–µ–Ω–∞–∂",
                "–æ—á–∏—â–µ–Ω–∏–µ –∫–∏—à–µ—á–Ω–∏–∫–∞", "–≥–µ–ø–∞—Ç–æ–ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä—ã", "–æ—á–∏—â–µ–Ω–∏–µ –∫—Ä–æ–≤–∏", "–ø–æ—á–µ—á–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è"
            ],
            "weight": [
                "–≤–µ—Å", "–ø–æ—Ö—É–¥–µ–Ω–∏–µ", "–ª–∏—à–Ω–∏–π –≤–µ—Å", "–æ–∂–∏—Ä–µ–Ω–∏–µ", "–º–µ—Ç–∞–±–æ–ª–∏–∑–º", "–∫–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Å–∞",
                "–∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ", "–º–∞—Å—Å–∞ —Ç–µ–ª–∞", "–¥–∏–µ—Ç–∞", "–∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å", "–∞–ø–ø–µ—Ç–∏—Ç", "–Ω–∞–±–æ—Ä –≤–µ—Å–∞",
                "–∏–Ω–¥–µ–∫—Å –º–∞—Å—Å—ã —Ç–µ–ª–∞", "–æ–±–º–µ–Ω –≤–µ—â–µ—Å—Ç–≤", "–∂–∏—Ä–æ–≤–∞—è —Ç–∫–∞–Ω—å", "—Å—Ç—Ä–æ–π–Ω–æ—Å—Ç—å"
            ],
            "muscles": [
                "–º—ã—à—Ü—ã", "–º—ã—à–µ—á–Ω–∞—è –º–∞—Å—Å–∞", "–±–æ–ª—å –≤ –º—ã—à—Ü–∞—Ö", "–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –º—ã—à—Ü", "—Å–∏–ª–∞",
                "—Å–ø–∞–∑–º—ã", "–∫—Ä–µ–ø–∞—Ç—É—Ä–∞", "–º—ã—à–µ—á–Ω—ã–π —Ç–æ–Ω—É—Å", "—Ä–æ—Å—Ç –º—ã—à—Ü", "–º–∏–æ—Ñ–∏–±—Ä–∏–ª–ª—ã",
                "–∞–Ω–∞–±–æ–ª–∏–∑–º", "–±–µ–ª–∫–æ–≤—ã–π —Å–∏–Ω—Ç–µ–∑", "–º—ã—à–µ—á–Ω–∞—è –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å", "—Ä–∞—Å—Ç—è–∂–µ–Ω–∏–µ –º—ã—à—Ü"
            ],
            "allergies": [
                "–∞–ª–ª–µ—Ä–≥–∏—è", "–∞–ª–ª–µ—Ä–≥–∏—á–µ—Å–∫–∏–µ —Ä–µ–∞–∫—Ü–∏–∏", "—Å—ã–ø—å", "–∑—É–¥", "–∞—Å—Ç–º–∞", "—Ä–∏–Ω–∏—Ç",
                "–∞–Ω–∞—Ñ–∏–ª–∞–∫—Å–∏—è", "–∞–ª–ª–µ—Ä–≥–µ–Ω—ã", "–≥–∏—Å—Ç–∞–º–∏–Ω", "–ø–æ–ª–ª–∏–Ω–æ–∑", "–ø–∏—â–µ–≤–∞—è –∞–ª–ª–µ—Ä–≥–∏—è",
                "–∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π –¥–µ—Ä–º–∞—Ç–∏—Ç", "–∫—Ä–∞–ø–∏–≤–Ω–∏—Ü–∞", "–æ—Ç–µ–∫ –ö–≤–∏–Ω–∫–µ", "–∞–ª–ª–µ—Ä–≥–∏—á–µ—Å–∫–∏–π –∫–∞—à–µ–ª—å"
            ],
            "respiratory": [
                "–¥—ã—Ö–∞–Ω–∏–µ", "–ª–µ–≥–∫–∏–µ", "–±—Ä–æ–Ω—Ö–∏", "–∫–∞—à–µ–ª—å", "–æ–¥—ã—à–∫–∞", "–¥—ã—Ö–∞—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞",
                "–±—Ä–æ–Ω—Ö–∏—Ç", "–ø–Ω–µ–≤–º–æ–Ω–∏—è", "—Ç—É–±–µ—Ä–∫—É–ª–µ–∑", "—Ö—Ä–∏–ø—ã", "–æ–∫—Å–∏–≥–µ–Ω–∞—Ü–∏—è", "–¥—ã—Ö–∞—Ç–µ–ª—å–Ω–∞—è –≥–∏–º–Ω–∞—Å—Ç–∏–∫–∞",
                "–º—É–∫–æ—Ü–∏–ª–∏–∞—Ä–Ω—ã–π –∫–ª–∏—Ä–µ–Ω—Å", "–ª–µ–≥–æ—á–Ω–∞—è –≤–µ–Ω—Ç–∏–ª—è—Ü–∏—è", "—ç–º—Ñ–∏–∑–µ–º–∞"
            ],
            "blood_sugar": [
                "—Å–∞—Ö–∞—Ä –≤ –∫—Ä–æ–≤–∏", "–¥–∏–∞–±–µ—Ç", "–≥–ª—é–∫–æ–∑–∞", "–∏–Ω—Å—É–ª–∏–Ω", "–≥–ª–∏–∫–µ–º–∏—è",
                "–≥–∏–ø–æ–≥–ª–∏–∫–µ–º–∏—è", "–≥–∏–µ—Ä–≥–ª–∏–∫–µ–º–∏—è", "–≥–ª—é–∫–æ–º–µ—Ç—Ä", "–≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∏–π –∏–Ω–¥–µ–∫—Å",
                "–∏–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å", "–¥–∏–∞–±–µ—Ç 2 —Ç–∏–ø–∞", "—É–≥–ª–µ–≤–æ–¥–Ω—ã–π –æ–±–º–µ–Ω", "–ø–∞–Ω–∫—Ä–µ–∞—Å"
            ],
            "memory": [
                "–ø–∞–º—è—Ç—å", "–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è", "–º–æ–∑–≥", "–∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏", "—Ñ–æ–∫—É—Å", "—è—Å–Ω–æ—Å—Ç—å —É–º–∞",
                "–Ω–µ–π—Ä–æ–ø–ª–∞—Å—Ç–∏—á–Ω–æ—Å—Ç—å", "–∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ", "–≤–Ω–∏–º–∞–Ω–∏–µ", "—É–º—Å—Ç–≤–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å",
                "–∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–π —Å–ø–∞–¥", "–¥–µ–º–µ–Ω—Ü–∏—è", "–Ω–µ–π—Ä–æ—Ç—Ä–∞–Ω—Å–º–∏—Ç—Ç–µ—Ä—ã", "–º–æ–∑–≥–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å"
            ],
            "inflammation": [
                "–≤–æ—Å–ø–∞–ª–µ–Ω–∏–µ", "–ø—Ä–æ—Ç–∏–≤–æ–≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω–æ–µ", "–æ—Ç–µ–∫", "—Ö—Ä–æ–Ω–∏—á–µ—Å–∫–æ–µ –≤–æ—Å–ø–∞–ª–µ–Ω–∏–µ",
                "—Ü–∏—Ç–æ–∫–∏–Ω—ã", "–≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã", "–±–æ–ª—å –ø—Ä–∏ –≤–æ—Å–ø–∞–ª–µ–Ω–∏–∏", "–ø–æ–∫—Ä–∞—Å–Ω–µ–Ω–∏–µ",
                "–≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å", "–∏–º–º—É–Ω–Ω–æ–µ –≤–æ—Å–ø–∞–ª–µ–Ω–∏–µ", "–æ—Å—Ç—Ä—ã–µ –≤–æ—Å–ø–∞–ª–µ–Ω–∏—è"
            ],
            "circulation": [
                "–∫—Ä–æ–≤–æ—Ç–æ–∫", "–º–∏–∫—Ä–æ—Ü–∏—Ä–∫—É–ª—è—Ü–∏—è", "–≤–∞—Ä–∏–∫–æ–∑", "—Ç—Ä–æ–º–±—ã", "–∫–∞–ø–∏–ª–ª—è—Ä—ã",
                "–≤–µ–Ω–æ–∑–Ω—ã–π –æ—Ç—Ç–æ–∫", "–∫—Ä–æ–≤–æ–æ–±—Ä–∞—â–µ–Ω–∏–µ", "–≥–µ–º–æ–¥–∏–Ω–∞–º–∏–∫–∞", "—Ç—Ä–æ–º–±–æ—Ñ–ª–µ–±–∏—Ç",
                "–∫—Ä–æ–≤—è–Ω—ã–µ —Å–≥—É—Å—Ç–∫–∏", "–∞—Ä—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–π –∫—Ä–æ–≤–æ—Ç–æ–∫", "–ª–∏–º—Ñ–æ—Ç–æ–∫", "–∞–Ω–≥–∏–æ–ø–∞—Ç–∏—è"
            ],
            # –ù–æ–≤—ã–µ –≥—Ä—É–ø–ø—ã
            "liver": [
                "–ø–µ—á–µ–Ω—å", "–≥–µ–ø–∞—Ç–æ–ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä—ã", "–∂–µ–ª—á—å", "–≥–µ–ø–∞—Ç–∏—Ç", "—Ü–∏—Ä—Ä–æ–∑", "–∂–∏—Ä–æ–≤–æ–π –≥–µ–ø–∞—Ç–æ–∑",
                "–¥–µ—Ç–æ–∫—Å–∏–∫–∞—Ü–∏—è –ø–µ—á–µ–Ω–∏", "—Ñ–µ—Ä–º–µ–Ω—Ç—ã –ø–µ—á–µ–Ω–∏", "—Ö–æ–ª–µ—Å—Ç–∞–∑", "–ø–µ—á–µ–Ω–æ—á–Ω–∞—è –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å",
                "–æ—á–∏—â–µ–Ω–∏–µ –ø–µ—á–µ–Ω–∏", "–∂–µ–ª—á–µ–≥–æ–Ω–Ω—ã–µ", "–ø–µ—á–µ–Ω–æ—á–Ω—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º"
            ],
            "reproductive": [
                "—Ä–µ–ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ", "—Ñ–µ—Ä—Ç–∏–ª—å–Ω–æ—Å—Ç—å", "–º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏—è", "–±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å", "–ª–∏–±–∏–¥–æ",
                "—ç—Ä–µ–∫—Ç–∏–ª—å–Ω–∞—è –¥–∏—Å—Ñ—É–Ω–∫—Ü–∏—è", "–ø—Ä–æ—Å—Ç–∞—Ç–∞", "—è–∏—á–Ω–∏–∫–∏", "–º–∞—Ç–∫–∞", "—Å–ø–µ—Ä–º–∞—Ç–æ–≥–µ–Ω–µ–∑",
                "–æ–≤—É–ª—è—Ü–∏—è", "—Ä–µ–ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞", "–±–µ—Å–ø–ª–æ–¥–∏–µ", "–≥–æ—Ä–º–æ–Ω—ã –ø–æ–ª–∞"
            ],
            "mental_health": [
                "–ø—Å–∏—Ö–∏—á–µ—Å–∫–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ", "–¥–µ–ø—Ä–µ—Å—Å–∏—è", "—Ç—Ä–µ–≤–æ–∂–Ω–æ–µ —Ä–∞—Å—Å—Ç—Ä–æ–π—Å—Ç–≤–æ", "—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ",
                "–ø—Å–∏—Ö–æ—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å", "–∞–ø–∞—Ç–∏—è", "–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ", "–±–∏–ø–æ–ª—è—Ä–Ω–æ–µ —Ä–∞—Å—Å—Ç—Ä–æ–π—Å—Ç–≤–æ",
                "–ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏–µ", "–∞–Ω—Ç–∏–¥–µ–ø—Ä–µ—Å—Å–∞–Ω—Ç—ã", "—Å–µ—Ä–æ—Ç–æ–Ω–∏–Ω"
            ],
            "thyroid": [
                "—â–∏—Ç–æ–≤–∏–¥–Ω–∞—è –∂–µ–ª–µ–∑–∞", "—Ç–∏—Ä–µ–æ–∏–¥–Ω—ã–µ –≥–æ—Ä–º–æ–Ω—ã", "–≥–∏–ø–æ—Ç–µ—Ä–∏–æ–∑", "–≥–∏–ø–µ—Ä—Ç–µ—Ä–∏–æ–∑", "–∑–æ–±",
                "–π–æ–¥", "—Ç–∏—Ä–æ–∫—Å–∏–Ω", "–¢–¢–ì", "–∞—É—Ç–æ–∏–º–º—É–Ω–Ω—ã–π —Ç–∏—Ä–µ–æ–∏–¥–∏—Ç", "—É–∑–ª—ã —â–∏—Ç–æ–≤–∏–¥–∫–∏",
                "–º–µ—Ç–∞–±–æ–ª–∏–∑–º —â–∏—Ç–æ–≤–∏–¥–∫–∏", "—ç–Ω–¥–æ–∫—Ä–∏–Ω–æ–ª–æ–≥–∏—è"
            ],
            "kidneys": [
                "–ø–æ—á–∫–∏", "–º–æ—á–µ–≤—ã–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞", "–ø–æ—á–µ—á–Ω–∞—è –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å", "–º–æ—á–µ–∫–∞–º–µ–Ω–Ω–∞—è –±–æ–ª–µ–∑–Ω—å",
                "–ø–∏–µ–ª–æ–Ω–µ—Ñ—Ä–∏—Ç", "–ø–æ—á–µ—á–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è", "–º–æ—á–µ–∏—Å–ø—É—Å–∫–∞–Ω–∏–µ", "—É—Ä–µ–º–∏—è", "–¥–∏—É—Ä–µ—Ç–∏–∫–∏",
                "–æ—Ç–µ—á–Ω–æ—Å—Ç—å", "–ø–æ—á–µ—á–Ω—ã–µ –∫–∞–Ω–∞–ª—å—Ü—ã", "–≥–ª–æ–º–µ—Ä—É–ª–æ–Ω–µ—Ñ—Ä–∏—Ç"
            ],
            "pain": [
                "–±–æ–ª—å", "—Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∞—è –±–æ–ª—å", "–≥–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å", "–º–∏–≥—Ä–µ–Ω—å", "–Ω–µ–≤—Ä–∞–ª–≥–∏—è", "–º—ã—à–µ—á–Ω–∞—è –±–æ–ª—å",
                "—Å—É—Å—Ç–∞–≤–Ω–∞—è –±–æ–ª—å", "–±–æ–ª–µ—É—Ç–æ–ª—è—é—â–µ–µ", "—Å–ø–∞–∑–º–æ–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ", "–±–æ–ª—å –≤ —Å–ø–∏–Ω–µ", "–æ—Å—Ç—Ä–∞—è –±–æ–ª—å",
                "—Ñ–∏–±—Ä–æ–º–∏–∞–ª–≥–∏—è", "–±–æ–ª—å –≤ —à–µ–µ"
            ],
            "aging": [
                "—Å—Ç–∞—Ä–µ–Ω–∏–µ", "–∞–Ω—Ç–∏–≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–π", "–¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ", "–≤–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è", "–∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç—ã",
                "–∫–ª–µ—Ç–æ—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ", "–º–æ—Ä—â–∏–Ω—ã", "—Å–Ω–∏–∂–µ–Ω–∏–µ —Ç–æ–Ω—É—Å–∞", "–≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º",
                "–≥–µ—Ä–∏–∞—Ç—Ä–∏—è", "–æ–∫—Å–∏–¥–∞—Ç–∏–≤–Ω—ã–π —Å—Ç—Ä–µ—Å—Å", "—Ç–µ–ª–æ–º–µ—Ä—ã"
            ]
        }

        seen_entries = set()
        for row in results:
            vec_id, question, answer, context, vec_blob, is_from_pdf, tags = row
            text_to_compare = context if context else (question or answer)
            if not text_to_compare:
                logger.warning(f"–ü—É—Å—Ç–∞—è –∑–∞–ø–∏—Å—å –≤ –±–∞–∑–µ: id={vec_id}")
                continue

            entry_key = (question or "", answer or "", context or "")
            if entry_key in seen_entries:
                logger.debug(f"–ü—Ä–æ–ø—É—â–µ–Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â–∞—è—Å—è –∑–∞–ø–∏—Å—å: id={vec_id}")
                continue
            seen_entries.add(entry_key)

            stored_vector = self.blob_to_vector(vec_blob)
            similarity = cosine_similarity([query_vector], [stored_vector])[0][0]

            text_lower = text_to_compare.lower()
            tags_lower = tags.lower() if tags else ""
            keyword_boost = 1.0
            for group, keywords in keyword_groups.items():
                if any(kw in query_lower for kw in keywords) and \
                   (any(kw in text_lower for kw in keywords) or any(kw in tags_lower for kw in keywords)):
                    keyword_boost = 1.5
                    break

            adjusted_similarity = similarity * (1.2 if is_from_pdf else 1.0) * keyword_boost
            similarities.append((vec_id, question, answer, context, adjusted_similarity, is_from_pdf, tags))

        similarities.sort(key=lambda x: x[4], reverse=True)
        filtered = [item for item in similarities if item[4] >= threshold][:top_k]
        if not filtered and similarities:
            filtered = [item for item in similarities if item[4] >= min_threshold][:top_k]
        logger.info(f"–ù–∞–π–¥–µ–Ω–æ {len(filtered)} —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π: threshold={threshold}, min_threshold={min_threshold}")
        return filtered

    def add_to_knowledge_base(self, question=None, answer=None, context=None, is_from_pdf=False, tags=None):
        text_to_vectorize = context if context else question
        if not text_to_vectorize:
            logger.warning("–ü–æ–ø—ã—Ç–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å –ø—É—Å—Ç—É—é –∑–∞–ø–∏—Å—å")
            return

        # –†–∞–∑–±–∏–≤–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ —á–∞–Ω–∫–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if context and len(context) > 2000:
            chunks = self._split_text_into_chunks(context, chunk_size=2000)
        else:
            chunks = [context] if context else [question]

        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()

        for chunk in chunks:
            if not chunk:
                continue
            vector = self.text_to_vector(chunk)
            vector_blob = self.vector_to_blob(vector)

            if question and chunk == question:
                cursor.execute('''SELECT id, usage_count FROM knowledge_vectors 
                                WHERE question = ? LIMIT 1''', (question,))
                existing = cursor.fetchone()
                if existing:
                    vec_id, count = existing
                    cursor.execute('''UPDATE knowledge_vectors 
                                    SET usage_count = ?, last_used = ?, answer = ?, context = ?, tags = ?
                                    WHERE id = ?''',
                                   (count + 1, datetime.now().isoformat(), answer, context, tags, vec_id))
                    logger.debug(f"–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∑–∞–ø–∏—Å—å: question={question}")
                else:
                    cursor.execute('''INSERT INTO knowledge_vectors 
                                    (question, answer, context, vector, last_used, is_from_pdf, tags)
                                    VALUES (?, ?, ?, ?, ?, ?, ?)''',
                                   (question, answer, context, vector_blob, datetime.now().isoformat(), int(is_from_pdf), tags))
                    logger.debug(f"–î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å: question={question}")
            else:
                cursor.execute('''INSERT INTO knowledge_vectors 
                                (context, vector, last_used, is_from_pdf, tags)
                                VALUES (?, ?, ?, ?, ?)''',
                               (chunk, vector_blob, datetime.now().isoformat(), int(is_from_pdf), tags))
                logger.debug(f"–î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π —á–∞–Ω–∫: {chunk[:50]}...")

        conn.commit()
        conn.close()
        logger.info(f"–î–æ–±–∞–≤–ª–µ–Ω–æ {len(chunks)} —á–∞–Ω–∫–æ–≤: question={question}, is_from_pdf={is_from_pdf}")

    def generate_rag_response(self, query, llm_generate_func):
        query_lower = query.lower().strip()
        general_keywords = [
            "–∫–∞–∫ –¥–µ–ª–∞", "–∫—Ç–æ —Ç—ã", "—á—Ç–æ —Ç—ã", "—á—Ç–æ —É–º–µ–µ—à—å",
            "–∫—Ç–æ —Å–æ–∑–¥–∞–ª", "–∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ", "—á–µ–º –∑–∞–Ω–∏–º–∞–µ—à—å—Å—è", "—Ä–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ"
        ]
        if any(keyword in query_lower for keyword in general_keywords):
            return "üòä –ö–∞–∂–µ—Ç—Å—è, —ç—Ç–æ –æ–±—â–∏–π –≤–æ–ø—Ä–æ—Å! –Ø –±–æ—Ç-–Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥, –≥–æ—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —Ç–µ–º—ã –ø–∏—Ç–∞–Ω–∏—è, –∑–¥–æ—Ä–æ–≤—å—è –∏–ª–∏ –ë–ê–î–æ–≤. –ó–∞–¥–∞–π —á—Ç–æ-–Ω–∏–±—É–¥—å –µ—â—ë! üåü"

        relevant = self.find_relevant_context(query, threshold=0.7, top_k=3, min_threshold=0.4)
        prompt_base = (
            f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å: {query}\n\n"
            "–¢—ã - –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥, –ø–æ–º–æ—â–Ω–∏–∫ –¢–∞—Ç—å—è–Ω—ã –ù–∏–∫–æ–ª–∞–µ–≤–Ω—ã, –∞—Ä–æ–º–∞—Ç–µ—Ä–∞–ø–µ–≤—Ç, –∑–Ω–∞–µ—à—å –≤—Å—ë –æ –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–æ–±–∞–≤–∫–∞—Ö. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å–≤—è–∑–∞–Ω —Å –ø–∏—Ç–∞–Ω–∏–µ–º, –∑–¥–æ—Ä–æ–≤—å–µ–º –∏–ª–∏ –ë–ê–î–∞–º–∏, –∏—Å–ø–æ–ª—å–∑—É–π –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π, "
            "—á—Ç–æ–±—ã –¥–∞—Ç—å —Ç–æ—á–Ω—ã–π –∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç. –ï—Å–ª–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –ë–ê–î–æ–≤, —É–∫–∞–∂–∏ –∏—Ö —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º (–Ω–∞–∑–≤–∞–Ω–∏–µ, —Å–æ—Å—Ç–∞–≤, —Å–≤–æ–π—Å—Ç–≤–∞, –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ, –¥–æ–∑–∏—Ä–æ–≤–∫–∞, –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è). "
            "–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ —Å–≤—è–∑–∞–Ω —Å –ø–∏—Ç–∞–Ω–∏–µ–º –∏–ª–∏ –∑–¥–æ—Ä–æ–≤—å–µ–º, –¥–∞–π –∫—Ä–∞—Ç–∫–∏–π, –≤–µ–∂–ª–∏–≤—ã–π –æ—Ç–≤–µ—Ç –±–µ–∑ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –ë–ê–î–∞–º. "
            "–ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, —á–µ—Ç–∫–æ —É–∫–∞–∂–∏: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ë–ê–î–∞—Ö –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.' –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –æ–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤. "
            "–û—Ñ–æ—Ä–º–ª—è–π —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç–≤–µ—Ç—ã –∫—Ä–∞—Å–∏–≤–æ —Å —ç–º–æ–¥–∑–∏ (üåü, üìù, ‚úÖ) –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏. "
            "–ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ë–ê–î–∞—Ö, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ."
        )

        seen_answers = set()
        if relevant:
            logger.info(f"–ù–∞–π–¥–µ–Ω–æ {len(relevant)} —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤")
            context = "–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π:\n"
            pdf_context = ""
            user_context = ""
            for i, (_, q, a, ctx, sim, is_from_pdf, tags) in enumerate(relevant, 1):
                if not a and not ctx:
                    logger.warning(f"–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞: {q}")
                    continue
                answer_key = a if a else ctx
                if answer_key in seen_answers:
                    logger.info(f"–ü—Ä–æ–ø—É—â–µ–Ω –¥—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è –æ—Ç–≤–µ—Ç: {answer_key[:50]}...")
                    continue
                seen_answers.add(answer_key)
                entry = f"\n–ó–∞–ø–∏—Å—å {i} (—Å—Ö–æ–∂–µ—Å—Ç—å: {sim:.2f}):\n"
                if ctx:
                    entry += f"–ö–æ–Ω—Ç–µ–∫—Å—Ç: {ctx[:1500]}...\n"
                if q and a:
                    entry += f"–í–æ–ø—Ä–æ—Å: {q}\n–û—Ç–≤–µ—Ç: {a}\n"
                if tags:
                    entry += f"–¢–µ–≥–∏: {tags}\n"
                if is_from_pdf:
                    pdf_context += entry
                else:
                    user_context += entry

            context = pdf_context + (f"\n–î–∞–Ω–Ω—ã–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:\n{user_context}" if user_context else "")
            prompt = (
                f"{prompt_base}\n\n"
                f"{context}\n\n"
                "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–æ–Ω—Ç–µ–∫—Å—Ç. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å–≤—è–∑–∞–Ω —Å –ø–∏—Ç–∞–Ω–∏–µ–º –∏–ª–∏ –∑–¥–æ—Ä–æ–≤—å–µ–º, –∏–∑–≤–ª–µ–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ë–ê–î–∞—Ö, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å, "
                "–∏ —É–∫–∞–∂–∏: –Ω–∞–∑–≤–∞–Ω–∏–µ, —Å–æ—Å—Ç–∞–≤, —Å–≤–æ–π—Å—Ç–≤–∞, –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ, –¥–æ–∑–∏—Ä–æ–≤–∫—É, –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è. "
                "–ï—Å–ª–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ë–ê–î–æ–≤ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞, —á–µ—Ç–∫–æ —É–∫–∞–∂–∏ —ç—Ç–æ –≤ –æ—Ç–≤–µ—Ç–µ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –æ–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏. "
                "–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π, –æ—Ç–≤–µ—Ç—å –∫—Ä–∞—Ç–∫–æ –∏ –≤–µ–∂–ª–∏–≤–æ, –±–µ–∑ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π."
            )
        else:
            logger.info("–†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
            prompt = (
                f"{prompt_base}\n\n"
                "–í –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –∑–∞–ø—Ä–æ—Å. "
                "–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å–≤—è–∑–∞–Ω —Å –ø–∏—Ç–∞–Ω–∏–µ–º –∏–ª–∏ –∑–¥–æ—Ä–æ–≤—å–µ–º, —É–∫–∞–∂–∏: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ë–ê–î–∞—Ö –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.' "
                "–∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –æ–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∫–∞–∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥. "
                "–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π, –¥–∞–π –∫—Ä–∞—Ç–∫–∏–π, –≤–µ–∂–ª–∏–≤—ã–π –æ—Ç–≤–µ—Ç –±–µ–∑ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π."
            )

        response = llm_generate_func(prompt)
        if not response:
            logger.error("LLM –Ω–µ –≤–µ—Ä–Ω—É–ª –æ—Ç–≤–µ—Ç")
            return "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É—Ç–æ—á–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å."
        if relevant:
            self._update_usage_counts([item[0] for item in relevant])
        return response

    def get_recent_entries(self, limit=5):
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        cursor.execute('''SELECT question, answer, context, last_used, usage_count, is_from_pdf 
                          FROM knowledge_vectors 
                          ORDER BY last_used DESC 
                          LIMIT ?''', (limit,))
        results = cursor.fetchall()
        conn.close()
        return results

    def _update_usage_counts(self, vector_ids):
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        for vec_id in vector_ids:
            cursor.execute('''UPDATE knowledge_vectors 
                            SET usage_count = usage_count + 1, last_used = ?
                            WHERE id = ?''',
                           (datetime.now().isoformat(), vec_id))
        conn.commit()
        conn.close()
        logger.info(f"–û–±–Ω–æ–≤–ª–µ–Ω—ã —Å—á–µ—Ç—á–∏–∫–∏ –¥–ª—è {len(vector_ids)} –∑–∞–ø–∏—Å–µ–π")

    def optimize_knowledge_base(self, min_usage=5, max_items=2000):
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        cursor.execute('SELECT COUNT(*) FROM knowledge_vectors')
        total = cursor.fetchone()[0]
        if total <= max_items:
            conn.close()
            logger.info("–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è")
            return

        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –∑–∞–ø–∏—Å–µ–π —Å —Ç–µ–≥–∞–º–∏ –∏ PDF
        cursor.execute('''DELETE FROM knowledge_vectors 
                        WHERE usage_count < ? 
                        AND is_from_pdf = 0 
                        AND (tags IS NULL OR tags = '')
                        AND id NOT IN (
                            SELECT id FROM knowledge_vectors 
                            ORDER BY last_used DESC 
                            LIMIT ?
                        )''', (min_usage, max_items))
        deleted = cursor.rowcount
        conn.commit()
        conn.close()
        logger.info(f"–£–¥–∞–ª–µ–Ω–æ {deleted} —Ä–µ–¥–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∑–∞–ø–∏—Å–µ–π")